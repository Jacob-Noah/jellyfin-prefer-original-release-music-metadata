<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Prefer Original Release Music Metadata</title>
</head>
<body>
    <div id="PreferOriginalReleaseMusicMetadataConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="PreferOriginalReleaseMusicMetadataConfigForm">
                    <div class="verticalSection">
                        <h2>Prefer Original Release Music Metadata Configuration</h2>
                        <p>This plugin forces Jellyfin to prefer original release dates over standard release dates in music metadata.</p>
                        <p>The plugin recognizes the following metadata tags:</p>
                        <ul>
                            <li><strong>TDOR</strong>: ID3v2.4 Original Release Year tag (highest priority)</li>
                            <li><strong>OriginalReleaseDate</strong>: Custom field for full date information</li>
                            <li><strong>OriginalYear</strong>: Custom field for year-only information</li>
                            <li><strong>Original Date</strong>: Vorbis comment field for original release date</li>
                        </ul>
                        <p><strong>Usage</strong>: After enabling this feature, run the "Apply Original Release Date Metadata" scheduled task to process your music library. The task uses smart caching to only reprocess items with changed metadata, making subsequent runs much faster.</p>
                    </div>
                    
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="enablePreferOriginalRelease" />
                            <span>Enable Plugin</span>
                        </label>
                        <div class="fieldDescription">
                            When enabled, the scheduled task will apply original release dates from file metadata to your music library.
                            Run the "Apply Original Release Date Metadata" scheduled task to process your library. You can set up an automatic schedule on the <a href="#/dashboard/tasks">Scheduled Tasks</a> page if desired.
                        </div>
                    </div>

                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block">
                            <span>Save</span>
                        </button>
                    </div>
                    
                    <div class="verticalSection">
                        <h3>Cache Management</h3>
                        <p>The plugin caches processed items to avoid reprocessing unchanged files. Clear the cache to force reprocessing all items on the next task run.</p>
                        <button is="emby-button" type="button" id="clearCacheButton" class="raised block emby-button">
                            <span>Clear Processing Cache</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <script type="text/javascript">
            var PreferOriginalReleaseMusicMetadataConfig = {
                pluginUniqueId: '7c8df481-8eee-4b3a-9a3a-5c5e5e5e5e5e'
            };

            document.getElementById('PreferOriginalReleaseMusicMetadataConfigPage').addEventListener('pageshow', function () {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(PreferOriginalReleaseMusicMetadataConfig.pluginUniqueId).then(function (config) {
                    document.getElementById('enablePreferOriginalRelease').checked = config.EnablePreferOriginalRelease;
                    Dashboard.hideLoadingMsg();
                });
                
                // Attach clear cache button handler
                document.querySelector('#clearCacheButton').addEventListener('click', function (e) {
                    e.preventDefault();
                    
                    if (confirm('This will clear the processing cache and force all items to be reprocessed on the next task run. Continue?')) {
                        Dashboard.showLoadingMsg();
                        
                        var url = ApiClient.getUrl('PreferOriginalReleaseMusicMetadata/Cache');
                        
                        fetch(url, {
                            method: 'DELETE',
                            headers: {
                                'X-Emby-Token': ApiClient.accessToken()
                            }
                        }).then(function (response) {
                            Dashboard.hideLoadingMsg();
                            if (response.ok) {
                                alert('Cache cleared successfully. All items will be reprocessed on the next task run.');
                            } else {
                                return response.text().then(function(text) {
                                    alert('Error clearing cache: ' + text);
                                });
                            }
                        }).catch(function (error) {
                            Dashboard.hideLoadingMsg();
                            alert('Error clearing cache: ' + error.message);
                        });
                    }
                }, { once: true });
            });

            document.getElementById('PreferOriginalReleaseMusicMetadataConfigForm').addEventListener('submit', function (e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();

                ApiClient.getPluginConfiguration(PreferOriginalReleaseMusicMetadataConfig.pluginUniqueId).then(function (config) {
                    config.EnablePreferOriginalRelease = document.getElementById('enablePreferOriginalRelease').checked;

                    ApiClient.updatePluginConfiguration(PreferOriginalReleaseMusicMetadataConfig.pluginUniqueId, config).then(function () {
                        Dashboard.processPluginConfigurationUpdateResult();
                    });
                });

                return false;
            });
        </script>
    </div>
</body>
</html>
